<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>关于hive中reduce个数计算原理</title>
    <url>/2020/05/20/%E5%85%B3%E4%BA%8Ehive%E4%B8%ADreduce%E4%B8%AA%E6%95%B0%E8%AE%A1%E7%AE%97%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h2 id="hivesql日志"><a href="#hivesql日志" class="headerlink" title="hivesql日志"></a>hivesql日志</h2><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">INFO  : Query ID = hive_20200520224949_4adde175<span class="number">-8127</span><span class="number">-40</span>a5-bf4d-ff943d43237f</span><br><span class="line">INFO  : Total jobs = <span class="number">1</span></span><br><span class="line">INFO  : Launching Job <span class="number">1</span> out <span class="keyword">of</span> <span class="number">1</span></span><br><span class="line">INFO  : Starting task [Stage<span class="number">-1</span>:MAPRED] <span class="keyword">in</span> serial mode</span><br><span class="line">INFO  : Number <span class="keyword">of</span> reduce tasks determined <span class="keyword">at</span> compile <span class="built_in">time</span>: <span class="number">1</span></span><br><span class="line">INFO  : In order <span class="built_in">to</span> change <span class="keyword">the</span> <span class="built_in">average</span> <span class="built_in">load</span> <span class="keyword">for</span> <span class="keyword">a</span> reducer (<span class="keyword">in</span> <span class="keyword">bytes</span>):</span><br><span class="line">INFO  :   <span class="built_in">set</span> hive.exec.reducers.<span class="keyword">bytes</span>.per.reducer=&lt;<span class="built_in">number</span>&gt;</span><br><span class="line">INFO  : In order <span class="built_in">to</span> limit <span class="keyword">the</span> maximum <span class="built_in">number</span> <span class="keyword">of</span> reducers:</span><br><span class="line">INFO  :   <span class="built_in">set</span> hive.exec.reducers.<span class="built_in">max</span>=&lt;<span class="built_in">number</span>&gt;</span><br><span class="line">INFO  : In order <span class="built_in">to</span> <span class="built_in">set</span> <span class="keyword">a</span> <span class="built_in">constant</span> <span class="built_in">number</span> <span class="keyword">of</span> reducers:</span><br><span class="line">INFO  :   <span class="built_in">set</span> mapreduce.job.reduces=&lt;<span class="built_in">number</span>&gt;</span><br><span class="line">INFO  : <span class="built_in">number</span> <span class="keyword">of</span> splits:<span class="number">3</span></span><br><span class="line">INFO  : Submitting tokens <span class="keyword">for</span> job: job_1588214935553_2419</span><br><span class="line">INFO  : Kind: HDFS_DELEGATION_TOKEN, Service: ha-hdfs:nameservice1, Ident: (<span class="keyword">token</span> <span class="keyword">for</span> hive: HDFS_DELEGATION_TOKEN owner=hive/master2-dev.pagoda.com.cn@PAGODA.COM.DEV, renewer=yarn, realUser=, issueDate=<span class="number">1589986150572</span>, maxDate=<span class="number">1590590950572</span>, sequenceNumber=<span class="number">12805</span>, masterKeyId=<span class="number">113</span>)</span><br><span class="line">INFO  : The url <span class="built_in">to</span> track <span class="keyword">the</span> job: <span class="keyword">http</span>://hadoop123.cn:<span class="number">8088</span>/proxy/application_1588214935553_2419/</span><br><span class="line">下面这行表示提交到yarn的job已经生成了ID，到时你可以依据这个jobID来查询job的具体信息</span><br><span class="line">INFO  : Starting Job = job_1588214935553_2419, Tracking <span class="built_in">URL</span> = <span class="keyword">http</span>://hadoop123.cn:<span class="number">8088</span>/proxy/application_1588214935553_2419/</span><br><span class="line">下面这行表示如果此hive任务提交失败，则会执行此命令来<span class="built_in">kill</span>任务</span><br><span class="line">INFO  : Kill Command = /opt/cloudera/parcels/CDH<span class="number">-5.13</span><span class="number">.3</span><span class="number">-1.</span>cdh5<span class="number">.13</span><span class="number">.3</span>.p0<span class="number">.2</span>/lib/hadoop/bin/hadoop job  -<span class="built_in">kill</span> job_1588214935553_2419</span><br><span class="line">INFO  : Hadoop job information <span class="keyword">for</span> Stage<span class="number">-1</span>: <span class="built_in">number</span> <span class="keyword">of</span> mappers: <span class="number">3</span>; <span class="built_in">number</span> <span class="keyword">of</span> reducers: <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="日志中关键词解释"><a href="#日志中关键词解释" class="headerlink" title="日志中关键词解释"></a>日志中关键词解释</h3><p>hive.exec.reducers.bytes.per.reducer<br>这个参数控制一个job会有多少个reducer来处理，依据的是输入文件的总大小。默认1GB。<br>hive.exec.reducers.max<br>这个参数控制最大的reducer的数量，如果 input / bytes per reduce &gt; max  则会启动这个参数所指定的reduce个数。  这个并不会影响mapre.reduce.tasks参数的设置。默认的max是999。<br>mapred.reduce.tasks<br>这个参数如果指定了，hive就不会用它的estimation函数来自动计算reduce的个数，而是用这个参数来启动reducer。默认是-1.<br>如果不指定mapred.reduce.tasks，hive会根据输入数据的大小自动计算reduce的个数，计算公式：<br>reduce个数=InputFileSize/bytes.pe.reducer</p>
<h3 id="详细代码"><a href="#详细代码" class="headerlink" title="详细代码"></a>详细代码</h3><p>1.计算输入文件大小的方法：遍历每个路径获取文件大小并进行累加</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Calculate the total size of input files.</span></span><br><span class="line"><span class="comment">  * @param job the hadoop job conf.</span></span><br><span class="line"><span class="comment">  * @return the total size in bytes.</span></span><br><span class="line"><span class="comment">  * @ throws IOException </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="built_in">public</span> static long getTotalInputFileSize(JobConf job, mapredWork <span class="keyword">work</span>) throws IOException &#123;</span><br><span class="line">   long r = <span class="number">0</span>;</span><br><span class="line">   FileSystem fs = FileSystem.<span class="keyword">get</span>(job);</span><br><span class="line">   // <span class="keyword">For</span> <span class="keyword">each</span> <span class="keyword">input</span> <span class="type">path</span>, calculate the total size.</span><br><span class="line">   <span class="keyword">for</span> (String <span class="type">path</span>: <span class="keyword">work</span>.getPathToAliases().keySet()) &#123;</span><br><span class="line">     ContentSummary cs = fs.getContentSummary(<span class="built_in">new</span> Path(<span class="type">path</span>));</span><br><span class="line">     r += cs.getLength();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> r;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>2.计算reduce的个数</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Estimate the number of reducers needed for this job, based on job input,</span></span><br><span class="line"><span class="comment"> * and configuration parameters.</span></span><br><span class="line"><span class="comment"> * @return the number of reducers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="built_in">int</span> estimate<span class="constructor">NumberOfReducers(HiveConf <span class="params">hive</span>, JobConf <span class="params">job</span>, <span class="params">mapredWork</span> <span class="params">work</span>)</span> throws IOException &#123;</span><br><span class="line">  long bytesPerReducer = hive.get<span class="constructor">LongVar(HiveConf.ConfVars.BYTESPERREDUCER)</span>;</span><br><span class="line">  <span class="built_in">int</span> maxReducers = hive.get<span class="constructor">IntVar(HiveConf.ConfVars.MAXREDUCERS)</span>;</span><br><span class="line">  long totalInputFileSize = get<span class="constructor">TotalInputFileSize(<span class="params">job</span>, <span class="params">work</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="module-access"><span class="module"><span class="identifier">LOG</span>.</span></span>info(<span class="string">"BytesPerReducer="</span> + bytesPerReducer + <span class="string">" maxReducers="</span> + maxReducers </span><br><span class="line">      + <span class="string">" totalInputFileSize="</span> + totalInputFileSize);</span><br><span class="line">  <span class="built_in">int</span> reducers = (<span class="built_in">int</span>)((totalInputFileSize + bytesPerReducer - <span class="number">1</span>)<span class="operator"> / </span>bytesPerReducer);</span><br><span class="line">  reducers = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>max(<span class="number">1</span>, reducers);</span><br><span class="line">  reducers = <span class="module-access"><span class="module"><span class="identifier">Math</span>.</span></span>min(maxReducers, reducers);</span><br><span class="line">  return reducers;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.计算流程代码</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the number of reducers for the mapred work.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">protected <span class="type">void</span> setNumberOfReducers() throws IOException &#123;</span><br><span class="line">  // this <span class="keyword">is</span> a <span class="keyword">temporary</span> hack <span class="keyword">to</span> fix things that are <span class="keyword">not</span> fixed <span class="keyword">in</span> the compiler</span><br><span class="line">  <span class="type">Integer</span> numReducersFromWork = <span class="keyword">work</span>.getNumReduceTasks();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (numReducersFromWork != <span class="keyword">null</span> &amp;&amp; numReducersFromWork &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">LOG</span>.<span class="keyword">info</span>("Number of reduce tasks determined at compile: " + <span class="keyword">work</span>.getNumReduceTasks());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">work</span>.getReducer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">LOG</span>.<span class="keyword">info</span>("Number of reduce tasks not specified. Defaulting to 0 since there's no reduce operator");</span><br><span class="line">    <span class="keyword">work</span>.setNumReduceTasks(<span class="type">Integer</span>.valueOf(<span class="number">0</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">int</span> reducers = estimateNumberOfReducers(conf, job, <span class="keyword">work</span>);</span><br><span class="line">    <span class="keyword">work</span>.setNumReduceTasks(reducers);</span><br><span class="line">    <span class="keyword">LOG</span>.<span class="keyword">info</span>("Number of reduce tasks not specified. Estimated from input data size: " + reducers);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Hive</category>
      </categories>
  </entry>
  <entry>
    <title>Yarn的工作机制</title>
    <url>/2020/04/27/Yarn%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h2 id="Yarn基础架构"><a href="#Yarn基础架构" class="headerlink" title="Yarn基础架构"></a>Yarn基础架构</h2><p> 组成：  Yarn 主要由 ResourceManager、NodeManager、ApplicationMaster和Container等组件构成</p>
<h3 id="ResourceManager作用"><a href="#ResourceManager作用" class="headerlink" title="ResourceManager作用"></a>ResourceManager作用</h3><p>1.处理客户端请求<br>2.监控 NodeManager<br>3.启动或监控 ApplicationMaster<br>4.资源的分配和调度</p>
<h3 id="NodeManager作用"><a href="#NodeManager作用" class="headerlink" title="NodeManager作用"></a>NodeManager作用</h3><p>1.管理单个节点上的资源<br>2.处理来自 ResourceManager 的命令<br>3.处理来自 ApplicationMaster 的命令</p>
<h3 id="ApplicationMaster-作用"><a href="#ApplicationMaster-作用" class="headerlink" title="ApplicationMaster 作用"></a>ApplicationMaster 作用</h3><p>1.负责数据的切分<br>2.为应用程序申请资源并分配给内部的任务<br>3.任务的监控与容错</p>
<h3 id="Container-作用"><a href="#Container-作用" class="headerlink" title="Container 作用"></a>Container 作用</h3><p>Container 是 YARN 中的资源抽象，它封装了某个节点上的多维度资源，如内存、CPU、磁盘、网络等。</p>
<h2 id="yarn的工作机制"><a href="#yarn的工作机制" class="headerlink" title="yarn的工作机制"></a>yarn的工作机制</h2><p>（1）Mr 程序提交到客户端所在的节点（生成job.split、job.xml…等任务规划配置文件）。</p>
<p>（2）Yarnrunner 根据job运行所需资源向 Resourcemanager 申请 Application，RM 将job资源的提交路径和作业id返回给 yarnRunner，然后客户端提交jar包、切片信息和配置文件到指定的资源提交路径，然后申请运行 MrAppMaster。</p>
<p>（3）RM 将用户的请求初始化成一个 task，其中一个 NodeManager 领取到 task 任务，该 NodeManager 创建容器 Container，并产生 Appmaster。</p>
<p>（4）Container 从 HDFS 上拷贝任务规划配置文件以及资源到本地，MRAppMaster 向 RM 申请运行 MapTask 的资源，RM将运行 MapTask 任务分配给另外两个 NodeManager，另两个 NodeManager 分别领取任务并创建容器。</p>
<p>（5）AppMaster 向两个接收到任务的 NodeManager 发送程序启动脚本，这两个 NodeManager分别启动 MapTask 对数据分区排序。</p>
<p>（6）AppMaster 等待所有 MapTask 运行完毕后，向 RM 申请容器，运行 ReduceTask。</p>
<p>（7）ReduceTask 向 MapTask 获取相应分区的数据。程序运行完毕后，AppMaster 会向 RM 申请注销自己。</p>
]]></content>
      <categories>
        <category>Hadoop</category>
      </categories>
  </entry>
  <entry>
    <title>MapTask和ReduceTask运行机制</title>
    <url>/2020/04/26/MapTask%E5%92%8CReduceTask%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<h2 id="MapTask运行机制"><a href="#MapTask运行机制" class="headerlink" title="MapTask运行机制"></a>MapTask运行机制</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>1、 首先，读取数据组件InputFormat（默认TextInputFormat）会通过getSplits方法对输入目录中文件进行逻辑切片规划得到splits，有多少个split就对应启动多少个MapTask。split与block的对应关系默认是一对一。</p>
<p>2、 将输入文件切分为splits之后，由RecordReader对象（默认LineRecordReader）进行读取，以\n作为行分隔符，读取一行数据，返回&lt;key，value&gt;。Key表示每行首字符偏移值，value表示这一行文本内容。</p>
<p>3、 读取split返回&lt;key,value&gt;，进入用户自己继承的Mapper类中，执行用户重写的map函数。RecordReader读取一行这里调用一次。</p>
<p>4、 map逻辑完之后，将map的每条结果通过context.write进行collect数据收集。在collect中，会先对其进行分区处理，默认使用HashPartitioner。<br>MapReduce提供Partitioner接口，它的作用就是根据key或value及reduce的数量来决定当前的这对输出数据最终应该交由哪个reduce task处理。默认对key hash后再以reduce task数量取模。默认的取模方式只是为了平均reduce的处理能力，如果用户自己对Partitioner有需求，可以订制并设置到job上。</p>
<p>5、接下来，会将数据写入内存，内存中这片区域叫做环形缓冲区，缓冲区的作用是批量收集map结果，减少磁盘IO的影响。我们的key/value对以及Partition的结果都会被写入缓冲区。当然写入之前，key与value值都会被序列化成字节数组。<br>环形缓冲区其实是一个数组，数组中存放着key、value的序列化数据和key、value的元数据信息，包括partition、key的起始位置、value的起始位置以及value的长度。环形结构是一个抽象概念。<br>缓冲区是有大小限制，默认是100MB。当map task的输出结果很多时，就可能会撑爆内存，所以需要在一定条件下将缓冲区中的数据临时写入磁盘，然后重新利用这块缓冲区。这个从内存往磁盘写数据的过程被称为Spill，中文可译为溢写。这个溢写是由单独线程来完成，不影响往缓冲区写map结果的线程。溢写线程启动时不应该阻止map的结果输出，所以整个缓冲区有个溢写的比例spill.percent。这个比例默认是0.8，也就是当缓冲区的数据已经达到阈值（buffer size * spill percent = 100MB * 0.8 = 80MB），溢写线程启动，锁定这80MB的内存，执行溢写过程。Map task的输出结果还可以往剩下的20MB内存中写，互不影响。</p>
<p>6、当溢写线程启动后，需要对这80MB空间内的key做排序(Sort)。排序是MapReduce模型默认的行为，这里的排序也是对序列化的字节做的排序。<br>如果job设置过Combiner，那么现在就是使用Combiner的时候了。将有相同key的key/value对的value加起来，减少溢写到磁盘的数据量。Combiner会优化MapReduce的中间结果，所以它在整个模型中会多次使用。<br>那哪些场景才能使用Combiner呢？从这里分析，Combiner的输出是Reducer的输入，Combiner绝不能改变最终的计算结果。Combiner只应该用于那种Reduce的输入key/value与输出key/value类型完全一致，且不影响最终结果的场景。比如累加，最大值等。Combiner的使用一定得慎重，如果用好，它对job执行效率有帮助，反之会影响reduce的最终结果。</p>
<p>7、合并溢写文件：每次溢写会在磁盘上生成一个临时文件（写之前判断是否有combiner），如果map的输出结果真的很大，有多次这样的溢写发生，磁盘上相应的就会有多个临时文件存在。当整个数据处理结束之后开始对磁盘中的临时文件进行merge合并，因为最终的文件只有一个，写入磁盘，并且为这个文件提供了一个索引文件，以记录每个reduce对应数据的偏移量。</p>
<h3 id="简单概述"><a href="#简单概述" class="headerlink" title="简单概述"></a>简单概述</h3><p>inputFile通过split被逻辑切分为多个split文件，通过Record按行读取内容给map（用户自己实现的）进行处理，数据被map处理结束之后交给OutputCollector收集器，对其结果key进行分区（默认使用hash分区），然后写入buffer，每个map task都有一个内存缓冲区，存储着map的输出结果，当缓冲区快满的时候需要将缓冲区的数据以一个临时文件的方式存放到磁盘，当整个map task结束后再对磁盘中这个map task产生的所有临时文件做合并，生成最终的正式输出文件，然后等待reduce task来拉数据。</p>
<h3 id="mapTask相关配置mapred-site-xml"><a href="#mapTask相关配置mapred-site-xml" class="headerlink" title="mapTask相关配置mapred-site.xml"></a>mapTask相关配置mapred-site.xml</h3><p>设置一：设置环型缓冲区的内存值大小（默认设置如下）<br>mapreduce.task.io.sort.mb 100</p>
<p>设置二：设置溢写百分比（默认设置如下）<br>mapreduce.map.sort.spill.percent 0.80</p>
<p>设置三：设置溢写数据目录（默认设置）<br>mapreduce.cluster.local.dir ${hadoop.tmp.dir}/mapred/local</p>
<p>设置四：设置一次最多合并多少个溢写文件（默认设置如下）<br>mapreduce.task.io.sort.factor 10</p>
<h2 id="ReduceTask运行机制"><a href="#ReduceTask运行机制" class="headerlink" title="ReduceTask运行机制"></a>ReduceTask运行机制</h2><h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h3><p>1、Copy阶段，简单地拉取数据。Reduce进程启动一些数据copy线程(Fetcher)，通过HTTP方式请求maptask获取属于自己的文件。</p>
<p>2、Merge阶段。这里的merge如map端的merge动作，只是数组中存放的是不同map端copy来的数值。Copy过来的数据会先放入内存缓冲区中，这里的缓冲区大小要比map端的更为灵活。merge有三种形式：内存到内存；内存到磁盘；磁盘到磁盘。默认情况下第一种形式不启用。当内存中的数据量到达一定阈值，就启动内存到磁盘的merge。与map 端类似，这也是溢写的过程，这个过程中如果你设置有Combiner，也是会启用的，然后在磁盘中生成了众多的溢写文件。第二种merge方式一直在运行，直到没有map端的数据时才结束，然后启动第三种磁盘到磁盘的merge方式生成最终的文件。</p>
<p>3、合并排序。把分散的数据合并成一个大的数据后，还会再对合并后的数据排序。</p>
<p>4、对排序后的键值对调用reduce方法，键相等的键值对调用一次reduce方法，每次调用会产生零个或者多个键值对，最后把这些输出的键值对写入到HDFS文件中。</p>
<h3 id="简单概述-1"><a href="#简单概述-1" class="headerlink" title="简单概述"></a>简单概述</h3><p>Reduce大致分为copy、sort、reduce三个阶段，重点在前两个阶段。copy阶段包含一个eventFetcher来获取已完成的map列表，由Fetcher线程去copy数据，在此过程中会启动两个merge线程，分别为inMemoryMerger和onDiskMerger，分别将内存中的数据merge到磁盘和将磁盘中的数据进行merge。待数据copy完成之后，copy阶段就完成了，开始进行sort阶段，sort阶段主要是执行finalMerge操作，纯粹的sort阶段，完成之后就是reduce阶段，调用用户定义的reduce函数进行处理。</p>
]]></content>
      <categories>
        <category>Hadoop</category>
      </categories>
  </entry>
  <entry>
    <title>Griffin【简单使用】</title>
    <url>/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/</url>
    <content><![CDATA[<h2 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h2><h3 id="建库"><a href="#建库" class="headerlink" title="建库"></a>建库</h3><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">hive -e <span class="string">"create database griffin_demo"</span></span><br><span class="line">hive <span class="comment">--database griffin_demo</span></span><br></pre></td></tr></table></figure>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line">hive&gt; <span class="keyword">CREATE</span> EXTERNAL TABLE <span class="symbol">`demo_src`</span>(</span><br><span class="line">    &gt;   <span class="symbol">`id`</span> bigint,</span><br><span class="line">    &gt;   <span class="symbol">`age`</span> int,</span><br><span class="line">    &gt;   <span class="symbol">`desc`</span> <span class="keyword">string</span>)</span><br><span class="line">    &gt; PARTITIONED <span class="keyword">BY</span> (</span><br><span class="line">    &gt;   <span class="symbol">`dt`</span> <span class="keyword">string</span>,</span><br><span class="line">    &gt;   <span class="symbol">`hour`</span> <span class="keyword">string</span>)</span><br><span class="line">    &gt; ROW FORMAT DELIMITED</span><br><span class="line">    &gt;   FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">'|'</span></span><br><span class="line">    &gt; LOCATION</span><br><span class="line">    &gt;   <span class="string">'hdfs:///griffin/data/batch/demo_src'</span>;</span><br><span class="line"></span><br><span class="line">hive&gt; <span class="keyword">CREATE</span> EXTERNAL TABLE <span class="symbol">`demo_tgt`</span>(</span><br><span class="line">    &gt;   <span class="symbol">`id`</span> bigint,</span><br><span class="line">    &gt;   <span class="symbol">`age`</span> int,</span><br><span class="line">    &gt;   <span class="symbol">`desc`</span> <span class="keyword">string</span>)</span><br><span class="line">    &gt; PARTITIONED <span class="keyword">BY</span> (</span><br><span class="line">    &gt;   <span class="symbol">`dt`</span> <span class="keyword">string</span>,</span><br><span class="line">    &gt;   <span class="symbol">`hour`</span> <span class="keyword">string</span>)</span><br><span class="line">    &gt; ROW FORMAT DELIMITED</span><br><span class="line">    &gt;   FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">'|'</span></span><br><span class="line">    &gt; LOCATION</span><br><span class="line">	&gt;   <span class="string">'hdfs:///griffin/data/batch/demo_tgt'</span>;</span><br></pre></td></tr></table></figure>
<h3 id="load数据"><a href="#load数据" class="headerlink" title="load数据"></a>load数据</h3><p>(为了更直观的验证计算结果的准确性在此不按照官网上的操作进行)<br>（1）数据<br>demo_src.txt(10条)</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">1000</span>|<span class="number">10</span>|a</span><br><span class="line"><span class="number">1001</span>|<span class="number">11</span>|</span><br><span class="line"><span class="number">1002</span>|<span class="number">16</span>|b</span><br><span class="line"><span class="number">1003</span>|<span class="number">21</span>|</span><br><span class="line"><span class="number">1004</span>|<span class="number">10</span>|c</span><br><span class="line"><span class="number">1005</span>|<span class="number">11</span>|</span><br><span class="line"><span class="number">1006</span>|<span class="number">16</span>|d</span><br><span class="line"><span class="number">1007</span>|<span class="number">21</span>|</span><br><span class="line"><span class="number">1008</span>|<span class="number">10</span>|e</span><br><span class="line"><span class="number">1009</span>|<span class="number">18</span>|</span><br></pre></td></tr></table></figure>
<p>demo_tgt.txt(10条)</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"><span class="number">1001</span>|<span class="number">10</span>|a</span><br><span class="line"><span class="number">1002</span>|<span class="number">10</span>|</span><br><span class="line"><span class="number">1003</span>|<span class="number">16</span>|b</span><br><span class="line"><span class="number">1004</span>|<span class="number">10</span>|</span><br><span class="line"><span class="number">1005</span>|<span class="number">16</span>|c</span><br><span class="line"><span class="number">1006</span>|<span class="number">10</span>|</span><br><span class="line"><span class="number">1007</span>|<span class="number">16</span>|d</span><br><span class="line"><span class="number">1008</span>|<span class="number">10</span>|</span><br><span class="line"><span class="number">1009</span>|<span class="number">16</span>|e</span><br><span class="line"><span class="number">1010</span>|<span class="number">10</span>|</span><br></pre></td></tr></table></figure>
<p>（2）load数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/opt/module/griffin/data/demo_src.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> demo_src <span class="keyword">partition</span>(dt=<span class="number">20200117</span>,<span class="keyword">hour</span>=<span class="number">9</span>)</span><br><span class="line"><span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> inpath <span class="string">'/opt/module/griffin/data/demo_tgt.txt'</span> <span class="keyword">into</span> <span class="keyword">table</span> demo_tgt <span class="keyword">partition</span>(dt=<span class="number">20200117</span>,<span class="keyword">hour</span>=<span class="number">9</span>)</span><br></pre></td></tr></table></figure>
<h2 id="UI操作"><a href="#UI操作" class="headerlink" title="UI操作"></a>UI操作</h2><p>UI操作文档连接：<a href="https://github.com/apache/griffin/blob/master/griffin-doc/ui/user-guide.md" target="_blank" rel="noopener">https://github.com/apache/griffin/blob/master/griffin-doc/ui/user-guide.md</a></p>
<h3 id="程序流程图"><a href="#程序流程图" class="headerlink" title="程序流程图"></a>程序流程图</h3><img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/01.png" class="" title="This is an image">
<h3 id="Accuracy操作"><a href="#Accuracy操作" class="headerlink" title="Accuracy操作"></a>Accuracy操作</h3><p>Create Measure<br>（1）单击Measures，然后选择Create Measure。您可以使用该度量来处理数据并获得所需的结果。</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/02.png" class="" title="This is an image">
<p>主要有四种选择供您选择：<br>如果要测量源与目标之间的匹配率，请选择准确性。<br>如果要检查数据的特定值（例如：空列数），请选择分析。</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/03.png" class="" title="This is an image">
<p>（2）选择Accuracy<br>（3）选择将用于比较的源数据集和字段。</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/04.png" class="" title="This is an image">
<p>（4）选择将用于比较的目标数据集和字段。</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/05.png" class="" title="This is an image">
<p>（5）映射源数据集和目标<br>选择匹配源和目标的规则。这里有6个选项可供选择：<br>=：两列的数据应完全匹配。<br>！=：两列的数据应该不同。</p>
<blockquote>
<p>：目标列数据应大于源列数据。<br>=：目标列数据应大于或等于源列数据。<br>&lt;：目标列数据应小于源列数据。<br>&lt;=：目标列数据应小于或等于源列数据。</p>
</blockquote>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/06.png" class="" title="This is an image">
<p>（6）分区配置<br>设置源数据集和目标数据集的分区配置。<br>分区大小是指配置单元数据库的最小数据单位，用于拆分要计算的数据完成的文件路径表示完成的文件路径的格式。注意：该处没有加where条件，关于加不加where条件的效果后面会有总结</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/07.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/08.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/09.png" class="" title="This is an image">
<p>假设源表demo_src具有1000条记录，目标表demo_tgt仅具有999条记录，并且demo_tgt与demo_src的Id完全匹配，则准确率= 999/1000 * 100％= 99.9％。</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/10.png" class="" title="This is an image">
<p>Create Job</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/11.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/12.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/13.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/14.png" class="" title="This is an image">
<p>查看结果</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/15.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/16.png" class="" title="This is an image">

<h3 id="Data-Profiling"><a href="#Data-Profiling" class="headerlink" title="Data Profiling"></a>Data Profiling</h3><p>Create Measure</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/17.png" class="" title="This is an image">
<p>选择Data Profiling</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/18.png" class="" title="This is an image">
<p>选择要统计的表和字段</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/19.png" class="" title="This is an image">
<p>简单的统计：空数、去重求count、    count(1)、最大、最低</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/20.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/21.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/22.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/23.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/24.png" class="" title="This is an image">
<p>Create Job</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/25.png" class="" title="This is an image">
<p>每五分钟计算一次</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/26.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/27.png" class="" title="This is an image">
<p>查看结果</p>
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/28.png" class="" title="This is an image">
<img src="/2020/01/21/Griffin%E3%80%90%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8%E3%80%91/29.png" class="" title="This is an image">
<h3 id="操作补充"><a href="#操作补充" class="headerlink" title="操作补充"></a>操作补充</h3><p>创建measure过程中,在Partition Configuration时where的设置问题存在以下三种情况：<br><font size = 2 color = red><br>（说明：分区表分区字段 dt、hour,partition Size=1 hour）<br></font><br><strong>情况一</strong>：where为空，计算库中所有的数据<br>如果where条件是null,不考虑range的范围，计算所有的数据，显示的计算时间为当前时间减range的下限<br>例：表中数据为10条，hour=8 的有6条 hour=9 的有4条，当前时间为17点，range:-3——0 显示的结果：time=14:00:00 count=10</p>
<p><strong>情况二</strong>：where指定具体分区，只计算指定分区的数据<br>如果where的条件为具体的日期，不考虑range的范围，计算指定日期的数据，显示的时间为当前时间减range的下限<br>例：表中数据为10条，hour=8 的有6条 hour=9 的有4条，当前时间为17点，where hour=8 range:-3——0 显示的结果：time=14:00:00 count=6</p>
<p><strong>情况三</strong>：where中的值为dt=#yyyyMMdd# AND hour=#HH#只会计算range范围内的数据<br>如果where中的条件为“dt=#yyyyMMdd# AND hour=#HH#”，会考虑range，计算的数据为range内的数据，显示的时间为当前时间减range的下限<br>例：表中数据为10条，hour=8 的有6条 hour=9 的有4条，当前时间为11点，range:-3——-1 显示的结果：time=11:00:00 count=10，如果range:0——0 这是计算当前分区的数据，显示的时间也为当前时间</p>
]]></content>
      <categories>
        <category>Griffin</category>
      </categories>
  </entry>
  <entry>
    <title>Griffin【安装部署】</title>
    <url>/2020/01/21/Griffin%E3%80%90%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E3%80%91/</url>
    <content><![CDATA[<p>（官网提供有中文版资料：<a href="http://griffin.apache.org/docs/quickstart-cn.html）" target="_blank" rel="noopener">http://griffin.apache.org/docs/quickstart-cn.html）</a></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>JDK (version 1.8)<br>MySQL(version 5.6)<br>Hadoop (version 2.7.2)<br>Hive (version 1.2.1)<br>Spark (version 2.2.1)<br>Livy（version 0.5）<br>ElasticSearch (version 6.3.1)</p>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>在MySQL中创建数据库quartz，然后执行<a href="https://github.com/apache/griffin/blob/master/service/src/main/resources/Init_quartz_mysql_innodb.sql" target="_blank" rel="noopener">Init_quartz_mysql_innodb.sql</a>脚本。</p>
<h2 id="Hadoop和Hive"><a href="#Hadoop和Hive" class="headerlink" title="Hadoop和Hive"></a>Hadoop和Hive</h2><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">#创建/<span class="built_in">home</span>/spark_conf目录</span><br><span class="line">hadoop fs -<span class="built_in">mkdir</span> -p /<span class="built_in">home</span>/spark_conf</span><br><span class="line">#上传hive-site.xml</span><br><span class="line">hadoop fs -<span class="built_in">put</span> hive-site.xml /<span class="built_in">home</span>/spark_conf/</span><br><span class="line">启动元数据服务</span><br><span class="line">/opt/<span class="keyword">module</span>/hive/bin/hive --service metastore</span><br></pre></td></tr></table></figure>
<h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><p>vim /etc/profile</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">JAVA_HOME</span>=/opt/module/jdk1.8</span><br><span class="line"><span class="comment">#spark目录</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">SPARK_HOME</span>=/opt/module/spark</span><br><span class="line"><span class="comment">#livy命令目录</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">LIVY_HOME</span>=/opt/module/livy/bin</span><br><span class="line"><span class="comment">#hadoop配置文件目录</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">HADOOP_CONF_DIR</span>=/opt/module/hadoop-2.7.2/etc/hadoop</span><br></pre></td></tr></table></figure>
<p>source /etc/profile</p>
<h2 id="Elasticsearch配置"><a href="#Elasticsearch配置" class="headerlink" title="Elasticsearch配置"></a>Elasticsearch配置</h2><p>在ES里创建griffin索引：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">curl -k -H "Content-Type: application/json" -XPUT http://hadoop200:9200/griffin -d '</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"aliases"</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">"mappings"</span>: &#123;</span><br><span class="line">        <span class="attr">"accuracy"</span>: &#123;</span><br><span class="line">            <span class="attr">"properties"</span>: &#123;</span><br><span class="line">                <span class="attr">"name"</span>: &#123;</span><br><span class="line">                    <span class="attr">"fields"</span>: &#123;</span><br><span class="line">                        <span class="attr">"keyword"</span>: &#123;</span><br><span class="line">                            <span class="attr">"ignore_above"</span>: <span class="number">256</span>,</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"keyword"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"text"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"tmst"</span>: &#123;</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"date"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"settings"</span>: &#123;</span><br><span class="line">        <span class="attr">"index"</span>: &#123;</span><br><span class="line">            <span class="attr">"number_of_replicas"</span>: <span class="string">"2"</span>,</span><br><span class="line">            <span class="attr">"number_of_shards"</span>: <span class="string">"5"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">'</span><br></pre></td></tr></table></figure>
<p>创建成功后会返回<br>{“acknowledged”:true,”shards_acknowledged”:true,”index”:”griffin”}</p>
<h2 id="Griffin源码打包部署"><a href="#Griffin源码打包部署" class="headerlink" title="Griffin源码打包部署"></a>Griffin源码打包部署</h2><p>(1)、下载Griffin源码包<br>Griffin的源码地址是：<a href="https://github.com/apache/griffin.git" target="_blank" rel="noopener">https://github.com/apache/griffin.git</a><br>(2)、使用IDEA打开源码<br>下载完成在idea中导入并展开源码的结构图如下：</p>
<img src="/2020/01/21/Griffin%E3%80%90%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E3%80%91/01.png" class="" title="This is an image">
<p>Griffin的源码主要包括griffin-doc、measure、service和ui四个模块<br>①    griffin-doc负责存放Griffin的文档;<br>②    measure负责与spark交互，执行统计任务;<br>③ service使用spring boot作为服务实现，负责给ui模块提供交互所需的restful api，保存统计任务，展示统计结果。<br>(3)、修改代码中的配置<br>①service/src/main/resources/application.properties：</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Apache Griffin应用名称</span></span><br><span class="line"><span class="meta">spring.application.name</span>=<span class="string">griffin_test</span></span><br><span class="line"><span class="comment"># MySQL数据库配置信息</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://hadoop200:3306/quartz?useSSL=false</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">Deepexi.123456</span></span><br><span class="line"><span class="meta">spring.jpa.generate-ddl</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="meta">spring.jpa.show-sql</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># Hive metastore</span></span><br><span class="line"><span class="meta">hive.metastore.uris</span>=<span class="string">thrift://hadoop200:9083</span></span><br><span class="line"><span class="meta">hive.metastore.dbname</span>=<span class="string">default</span></span><br><span class="line"><span class="meta">hive.hmshandler.retry.attempts</span>=<span class="string">15</span></span><br><span class="line"><span class="meta">hive.hmshandler.retry.interval</span>=<span class="string">2000ms</span></span><br><span class="line"><span class="comment">#Hive jdbc</span></span><br><span class="line"><span class="meta">hive.jdbc.className</span>=<span class="string">org.apache.hive.jdbc.HiveDriver</span></span><br><span class="line"><span class="meta">hive.jdbc.url</span>=<span class="string">jdbc:hive2://hadoop200</span></span><br><span class="line"><span class="meta">hive.need.kerberos</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">hive.keytab.user</span>=<span class="string">xxx@xx.com</span></span><br><span class="line"><span class="meta">hive.keytab.path</span>=<span class="string">/path/to/keytab/file</span></span><br><span class="line"><span class="comment"># Hive cache time</span></span><br><span class="line"><span class="meta">cache.evict.hive.fixedRate.in.milliseconds</span>=<span class="string">900000</span></span><br><span class="line"><span class="comment"># Kafka schema registry</span></span><br><span class="line"><span class="meta">kafka.schema.registry.url</span>=<span class="string">http:/hadoop200:8081</span></span><br><span class="line"><span class="comment"># Update job instance state at regular intervals</span></span><br><span class="line"><span class="meta">jobInstance.fixedDelay.in.milliseconds</span>=<span class="string">60000</span></span><br><span class="line"><span class="comment"># Expired time of job instance which is 7 days that is 604800000 milliseconds.Time unit only supports milliseconds</span></span><br><span class="line"><span class="meta">jobInstance.expired.milliseconds</span>=<span class="string">604800000</span></span><br><span class="line"><span class="comment"># schedule predicate job every 5 minutes and repeat 12 times at most</span></span><br><span class="line"><span class="comment">#interval time unit s:second m:minute h:hour d:day,only support these four units</span></span><br><span class="line"><span class="meta">predicate.job.interval</span>=<span class="string">5m</span></span><br><span class="line"><span class="meta">predicate.job.repeat.count</span>=<span class="string">12</span></span><br><span class="line"><span class="comment"># external properties directory location</span></span><br><span class="line"><span class="meta">external.config.location</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># external BATCH or STREAMING env</span></span><br><span class="line"><span class="meta">external.env.location</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># login strategy ("default" or "ldap")</span></span><br><span class="line"><span class="meta">login.strategy</span>=<span class="string">default</span></span><br><span class="line"><span class="comment"># ldap</span></span><br><span class="line"><span class="meta">ldap.url</span>=<span class="string">ldap://hostname:port</span></span><br><span class="line"><span class="meta">ldap.email</span>=<span class="string">@example.com</span></span><br><span class="line"><span class="meta">ldap.searchBase</span>=<span class="string">DC=org,DC=example</span></span><br><span class="line"><span class="meta">ldap.searchPattern</span>=<span class="string">(sAMAccountName=&#123;0&#125;)</span></span><br><span class="line"><span class="comment"># hdfs default name</span></span><br><span class="line"><span class="meta">fs.defaultFS</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># elasticsearch</span></span><br><span class="line"><span class="meta">elasticsearch.host</span>=<span class="string">hadoop200</span></span><br><span class="line"><span class="meta">elasticsearch.port</span>=<span class="string">9200</span></span><br><span class="line"><span class="meta">elasticsearch.scheme</span>=<span class="string">http</span></span><br><span class="line"><span class="comment"># elasticsearch.user = user</span></span><br><span class="line"><span class="comment"># elasticsearch.password = password</span></span><br><span class="line"><span class="comment"># livy</span></span><br><span class="line"><span class="meta">livy.uri</span>=<span class="string">http://hadoop200:8998/batches</span></span><br><span class="line"><span class="meta">livy.need.queue</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">livy.task.max.concurrent.count</span>=<span class="string">20</span></span><br><span class="line"><span class="meta">livy.task.submit.interval.second</span>=<span class="string">3</span></span><br><span class="line"><span class="meta">livy.task.appId.retry.count</span>=<span class="string">3</span></span><br><span class="line"><span class="meta">livy.need.kerberos</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">livy.server.auth.kerberos.principal</span>=<span class="string">livy/kerberos.principal</span></span><br><span class="line"><span class="meta">livy.server.auth.kerberos.keytab</span>=<span class="string">/path/to/livy/keytab/file</span></span><br><span class="line"><span class="comment"># yarn url</span></span><br><span class="line"><span class="meta">yarn.uri</span>=<span class="string">http://hadoop200:8088</span></span><br><span class="line"><span class="comment"># griffin event listener</span></span><br><span class="line"><span class="meta">internal.event.listeners</span>=<span class="string">GriffinJobEventHook</span></span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line"><span class="meta">logging.file</span>=<span class="string">logs/griffin-service.log</span></span><br></pre></td></tr></table></figure>
<p>②service/src/main/resources/quartz.properties</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="meta">org.quartz.scheduler.instanceName</span>=<span class="string">spring-boot-quartz</span></span><br><span class="line"><span class="meta">org.quartz.scheduler.instanceId</span>=<span class="string">AUTO</span></span><br><span class="line"><span class="meta">org.quartz.threadPool.threadCount</span>=<span class="string">5</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.class</span>=<span class="string">org.quartz.impl.jdbcjobstore.JobStoreTX</span></span><br><span class="line"><span class="comment"># If you use mysql as your database,set this property value to org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.driverDelegateClass</span>=<span class="string">org.quartz.impl.jdbcjobstore.StdJDBCDelegate</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.useProperties</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.misfireThreshold</span>=<span class="string">60000</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.tablePrefix</span>=<span class="string">QRTZ_</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.isClustered</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">org.quartz.jobStore.clusterCheckinInterval</span>=<span class="string">20000</span></span><br></pre></td></tr></table></figure>
<p>③service/src/main/resources/sparkProperties.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"file"</span>: <span class="string">"hdfs:///griffin/griffin-measure.jar"</span>,</span><br><span class="line">  <span class="attr">"className"</span>: <span class="string">"org.apache.griffin.measure.Application"</span>,</span><br><span class="line">  <span class="attr">"queue"</span>: <span class="string">"default"</span>,</span><br><span class="line">  <span class="attr">"numExecutors"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"executorCores"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"driverMemory"</span>: <span class="string">"1g"</span>,</span><br><span class="line">  <span class="attr">"executorMemory"</span>: <span class="string">"1g"</span>,</span><br><span class="line">  <span class="attr">"conf"</span>: &#123;</span><br><span class="line">    <span class="attr">"spark.yarn.dist.files"</span>: <span class="string">"hdfs:///home/spark_conf/hive-site.xml"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"files"</span>: [</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>④service/src/main/resources/env/env_batch.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"spark"</span>: &#123;</span><br><span class="line">    <span class="attr">"log.level"</span>: <span class="string">"WARN"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sinks"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"CONSOLE"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"max.log.lines"</span>: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"HDFS"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"hdfs:///griffin/persist"</span>,</span><br><span class="line">        <span class="attr">"max.persist.lines"</span>: <span class="number">10000</span>,</span><br><span class="line">        <span class="attr">"max.lines.per.file"</span>: <span class="number">10000</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"ELASTICSEARCH"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">        <span class="attr">"api"</span>: <span class="string">"http://hadoop200:9200/griffin/accuracy"</span>,</span><br><span class="line">        <span class="attr">"connection.timeout"</span>: <span class="string">"1m"</span>,</span><br><span class="line">        <span class="attr">"retry"</span>: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"griffin.checkpoint"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>⑤service/src/main/resources/env/env_streaming.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"spark"</span>: &#123;</span><br><span class="line">    <span class="attr">"log.level"</span>: <span class="string">"WARN"</span>,</span><br><span class="line">    <span class="attr">"checkpoint.dir"</span>: <span class="string">"hdfs:///griffin/checkpoint/$&#123;JOB_NAME&#125;"</span>,</span><br><span class="line">    <span class="attr">"init.clear"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"batch.interval"</span>: <span class="string">"1m"</span>,</span><br><span class="line">    <span class="attr">"process.interval"</span>: <span class="string">"5m"</span>,</span><br><span class="line">    <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"spark.default.parallelism"</span>: <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"spark.task.maxFailures"</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"spark.streaming.kafkaMaxRatePerPartition"</span>: <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">"spark.streaming.concurrentJobs"</span>: <span class="number">4</span>,</span><br><span class="line">      <span class="attr">"spark.yarn.maxAppAttempts"</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">"spark.yarn.am.attemptFailuresValidityInterval"</span>: <span class="string">"1h"</span>,</span><br><span class="line">      <span class="attr">"spark.yarn.max.executor.failures"</span>: <span class="number">120</span>,</span><br><span class="line">      <span class="attr">"spark.yarn.executor.failuresValidityInterval"</span>: <span class="string">"1h"</span>,</span><br><span class="line">      <span class="attr">"spark.hadoop.fs.hdfs.impl.disable.cache"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sinks"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"CONSOLE"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"max.log.lines"</span>: <span class="number">100</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"HDFS"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"hdfs:///griffin/persist"</span>,</span><br><span class="line">        <span class="attr">"max.persist.lines"</span>: <span class="number">10000</span>,</span><br><span class="line">        <span class="attr">"max.lines.per.file"</span>: <span class="number">10000</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"ELASTICSEARCH"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"method"</span>: <span class="string">"post"</span>,</span><br><span class="line">        <span class="attr">"api"</span>: <span class="string">"http://hadoop200:9200/griffin/accuracy"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"griffin.checkpoint"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"zk"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"hosts"</span>: <span class="string">"hadoop200:2181, hadoop201:2181, hadoop202:2181"</span>,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"griffin/infocache"</span>,</span><br><span class="line">        <span class="attr">"lock.path"</span>: <span class="string">"lock"</span>,</span><br><span class="line">        <span class="attr">"mode"</span>: <span class="string">"persist"</span>,</span><br><span class="line">        <span class="attr">"init.clear"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"close.clear"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(4)打包<br>mvn -Dmaven.test.skip=true clean install</p>
<img src="/2020/01/21/Griffin%E3%80%90%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E3%80%91/02.png" class="" title="This is an image">

<p><strong>编译打包时可能遇到的问题</strong><br>问题：IDEA中使用maven命令进行编译打包时报错，报错信息如下：</p>
<img src="/2020/01/21/Griffin%E3%80%90%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E3%80%91/03.png" class="" title="This is an image">
<p>原因：在UI在的pom.xml文件中，默认指定了安装node的版本号。如果之前本地没有安装过node的话，应该不会报这个错误的。因为我之前安装过的，所以需要修改pom.xml里面的node版本号：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nodeVersion</span>&gt;</span>$&#123;node.version&#125;<span class="tag">&lt;/<span class="name">nodeVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">npmVersion</span>&gt;</span>$&#123;npm.version&#125;<span class="tag">&lt;/<span class="name">npmVersion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>需要改成对应本地的版本号。</p>
<h2 id="上传jar包并启动"><a href="#上传jar包并启动" class="headerlink" title="上传jar包并启动"></a>上传jar包并启动</h2><p>打包命令执行完成后，会在service和measure模块的target目录下分别看到service-0.4.0.jar和measure-0.4.0.jar两个jar，将这两个jar分别拷贝到服务器对应的目录下。<br>1、    创建文件夹<br>mkdir /opt/module/griffin<br>2、    将service-0.4.0.jar和measure-0.4.0.jar上传至/opt/module/griffin目录下<br>3、    将measure-0.4.0.jar这个jar上传到HDFS的/griffin文件目录里, 因为spark在yarn集群上执行任务时，需要到HDFS的/griffin目录下加载griffin-measure.jar</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改jar名称</span></span><br><span class="line"><span class="attr">mv</span> <span class="string">measure-0.4.0.jar griffin-measure.jar</span></span><br><span class="line"><span class="comment">#在HDFS中创建griffin目录</span></span><br><span class="line"><span class="attr">hadoop</span> <span class="string">fs -mkdir /griffin</span></span><br><span class="line"><span class="comment">#上传griffin-measure.jar到HDFS文件目录里</span></span><br><span class="line"><span class="attr">hadoop</span> <span class="string">fs -put measure-0.4.0.jar /griffin/</span></span><br></pre></td></tr></table></figure>
<p>4、    运行service-0.4.0.jar，启动Griffin管理后台：<br>nohup java -jar service-0.4.0.jar&gt;service.out 2&gt;&amp;1 &amp;</p>
<h2 id="访问Griffin页面"><a href="#访问Griffin页面" class="headerlink" title="访问Griffin页面"></a>访问Griffin页面</h2><p>浏览器打开<a href="http://hadoop200:8080" target="_blank" rel="noopener">http://hadoop200:8080</a> 用户名：admmin密码：admin</p>
<img src="/2020/01/21/Griffin%E3%80%90%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E3%80%91/04.png" class="" title="This is an image">]]></content>
      <categories>
        <category>Griffin</category>
      </categories>
  </entry>
  <entry>
    <title>Elasticsearch安装教程</title>
    <url>/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<font size = 2 color = red >
备注：全程使用cwq用户操作，因为elasticsearch不允许直接使用root启动
</font>

<h2 id="单机版"><a href="#单机版" class="headerlink" title="单机版"></a>单机版</h2><p>1.下载地址<br>&emsp;官网：<a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<img src="/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/01.png" class="" title="This is an image">

<p>2.上传文件<br>&emsp;通过远程连接工具将文件上传到 /opt/software/目录下</p>
<p>3.解压<br>&emsp;将上传的tar包解压到opt/module/目录下<br>&emsp;tar-zxvf elasticsearch-6.3.1.tar.gz -C /opt/module/</p>
<p>4.修改配置<br>&emsp;修改elasticsearch-6.3.1/config/elasticsearch.yml文件中的host和port</p>
<img src="/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/02.png" class="" title="This is an image">

<p>5.启动ES<br>&emsp;进入解压后es的目录下然后执行启动命令<br>&emsp;[cwq@hadoop200 elasticsearch-6.3.1]# bin/elasticsearch</p>
<p>6.测试<br>&emsp;<a href="http://hadoop200:9200" target="_blank" rel="noopener">http://hadoop200:9200</a></p>
<img src="/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/03.png" class="" title="This is an image">

<h2 id="集群版"><a href="#集群版" class="headerlink" title="集群版"></a>集群版</h2><p>步骤 1: 下载安装包<br>&emsp;官网：<a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads/elasticsearch</a></p>
<p>步骤 2: 解压<br>&emsp;tar -zxvf elasticsearch-6.3.1.tar.gz -C /opt/module</p>
<p>步骤 3: 修改配置文件config/elasticsearch.yml</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta">#---------------------------------- Cluster ----------------------------------</span></span><br><span class="line"><span class="meta"># 设置集群名称</span></span><br><span class="line">cluster.name: myES</span><br><span class="line"><span class="meta"># ------------------------------------ Node ------------------------------------</span></span><br><span class="line"><span class="meta"># 当前节点名称，各个节点是不一样的</span></span><br><span class="line">node.name: node<span class="number">-200</span></span><br><span class="line"><span class="meta"># ----------------------------------- Memory -----------------------------------</span></span><br><span class="line"><span class="meta"># 关闭bootstrap的自检程序</span></span><br><span class="line">bootstrap.memory_lock: <span class="literal">false</span></span><br><span class="line">bootstrap.system_call_filter: <span class="literal">false</span></span><br><span class="line"><span class="meta"># ---------------------------------- Network -----------------------------------</span></span><br><span class="line"><span class="meta"># 给当前节点绑定 ip 地址</span></span><br><span class="line">network.host: hadoop200</span><br><span class="line"><span class="meta"># 端口号保持默认 9200</span></span><br><span class="line"><span class="meta">#http.port: 9200</span></span><br><span class="line"><span class="meta"># --------------------------------- Discovery ----------------------------------</span></span><br><span class="line"><span class="meta"># 集群个节点IP地址，也可以使用域名，需要各节点能够解析</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: [<span class="string">"hadoop200"</span>, <span class="string">"hadoop201"</span>, <span class="string">"hadoop202"</span>]</span><br></pre></td></tr></table></figure>

<p>步骤 4: 分发 ElasticSearch<br>&emsp;注意修改每个节点的名</p>
<img src="/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/04.png" class="" title="This is an image">

<p>步骤 5: 启动 ElasticSearch<br>&emsp;分别在 3 台设备上启动 ElasticSearch<br>&emsp;bin/elasticsearch &amp;</p>
<p>步骤 6: 查看 ElasticSearch 是否启动成功</p>
<img src="/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/05.png" class="" title="This is an image">

<p>步骤 7: 测试是否可以连接到 ElasticSearch<br>&emsp;curl <a href="http://hadoop200:9200/_cat/nodes?v" target="_blank" rel="noopener">http://hadoop200:9200/_cat/nodes?v</a></p>
<img src="/2020/01/19/Elasticsearch%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/06.png" class="" title="This is an image">
<p>&emsp;或者在浏览器中输入地址: <a href="http://hadoop200:9200/_cat/nodes?v" target="_blank" rel="noopener">http://hadoop200:9200/_cat/nodes?v</a></p>
<h2 id="问题及解决方案"><a href="#问题及解决方案" class="headerlink" title="问题及解决方案"></a>问题及解决方案</h2><p>&emsp;默认 elasticsearch 是单机访问模式，就是只能自己访问自己。 但是我们之后一定会设置成允许应用服务器通过网络方式访问。这时，elasticsearch 就会因为嫌弃单机版的低端默认配置而报错，甚至无法启动。 所以我们在这里就要把服务器的一些限制打开，能支持更多并发。<br>注意: 修改以下配置的时候需要切换到 root 用户, 每个节点都要修改.<br><strong>问题1：</strong>max file descriptors [4096] for elasticsearch process likely too low, increase to at least [65536] elasticsearch<br>原因：系统允许 Elasticsearch 打开的最大文件数需要修改成 65536<br>解决：<br>&emsp;vim /etc/security/limits.conf 添加内容：<br>&emsp;* soft nofile 65536<br>&emsp;* hard nofile 131072<br>&emsp;* soft nproc 2048<br>&emsp;* hard nproc 65536<br><strong>注意：“*” 不要省略掉</strong><br><strong>问题2：</strong>max number of threads [1024] for user [judy2] likely too low, increase to at least [2048] （CentOS7.x 不用改）<br>原因：允许最大进程数修该成4096<br>解决：<br>&emsp;vim /etc/security/limits.d/90-nproc.conf<br>&emsp;修改如下内容： * soft nproc 1024<br>&emsp;修改为* soft nproc 4096<br><strong>问题3：</strong>max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144] （CentOS7.x 不用改）<br>原因：一个进程可以拥有的虚拟内存区域的数量。<br>解决： 在 /etc/sysctl.conf 文件最后添加一行<br>&emsp;vm.max_map_count=262144</p>
]]></content>
      <categories>
        <category>Elasticsearch</category>
      </categories>
  </entry>
</search>
